---
phase: 05-model-tiers
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - hfs/core/model_selector.py
  - tests/unit/test_model_selector.py
autonomous: true

must_haves:
  truths:
    - "ModelSelector resolves role to appropriate tier considering escalation state"
    - "Phase overrides take precedence over role defaults"
    - "Escalation state takes highest precedence for tier selection"
    - "Provider fallback chain tries all available providers for a tier"
  artifacts:
    - path: "hfs/core/model_selector.py"
      provides: "Tier resolution and provider fallback logic"
      exports: ["ModelSelector"]
    - path: "tests/unit/test_model_selector.py"
      provides: "Unit tests for ModelSelector"
      min_lines: 50
  key_links:
    - from: "hfs/core/model_selector.py"
      to: "hfs/core/model_tiers.py"
      via: "ModelTiersConfig usage"
      pattern: "ModelTiersConfig"
    - from: "hfs/core/model_selector.py"
      to: "hfs/agno/providers.py"
      via: "ProviderManager.get_model"
      pattern: "provider_manager\\.get_model"
---

<objective>
Create the ModelSelector class that resolves agent roles to appropriate tier models with phase overrides and escalation state support.

Purpose: Implement tier resolution logic per MODL-01 (role-based tiers) and MODL-02 (phase-based selection).
Output: ModelSelector class with get_model() method that handles tier resolution and provider fallback.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-model-tiers/05-CONTEXT.md
@.planning/phases/05-model-tiers/05-RESEARCH.md
@.planning/phases/05-model-tiers/05-01-SUMMARY.md
@hfs/core/model_tiers.py
@hfs/agno/providers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModelSelector class</name>
  <files>hfs/core/model_selector.py</files>
  <action>
Create the ModelSelector class that resolves roles to tier-appropriate models:

```python
class ModelSelector:
    """Resolves role + triad to appropriate model via tier system."""

    def __init__(
        self,
        config: ModelTiersConfig,
        provider_manager: ProviderManager,
    ):
        self.config = config
        self.provider_manager = provider_manager

    def get_model(
        self,
        triad_id: str,
        role: str,
        phase: Optional[str] = None,
    ) -> Any:
        """Get model for role, considering phase overrides and escalation."""
        tier = self._resolve_tier(triad_id, role, phase)
        return self._get_model_for_tier(tier)

    def _resolve_tier(
        self,
        triad_id: str,
        role: str,
        phase: Optional[str] = None,
    ) -> str:
        """Resolve tier with priority: escalation > phase override > role default."""
        # 1. Check escalation state first (highest priority)
        escalation_key = f"{triad_id}:{role}"
        if escalation_key in self.config.escalation_state:
            return self.config.escalation_state[escalation_key]

        # 2. Check phase override
        if phase and phase in self.config.phase_overrides:
            if role in self.config.phase_overrides[phase]:
                return self.config.phase_overrides[phase][role]

        # 3. Use role default (fallback to "general" if not found)
        return self.config.role_defaults.get(role, "general")

    def _get_model_for_tier(self, tier: str) -> Any:
        """Get model from tier, trying each provider in order."""
        tier_config = self.config.tiers[tier]
        errors = []

        for provider in self.provider_manager.available_providers:
            if provider in tier_config.providers:
                model_id = tier_config.providers[provider]
                try:
                    return self.provider_manager.get_model(provider, model_id)
                except NoAvailableKeyError as e:
                    errors.append((provider, e))
                    continue

        # All providers failed
        raise NoAvailableKeyError(
            provider="all",
            model_id=tier,
            total_keys=0,
            cooling_down=0,
        )
```

Include proper logging (logger = logging.getLogger(__name__)).
Add docstrings following existing code style.
Import NoAvailableKeyError from keycycle.
  </action>
  <verify>python -c "from hfs.core.model_selector import ModelSelector; print('Import OK')"</verify>
  <done>ModelSelector class can be instantiated and get_model() method exists with tier resolution logic</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for ModelSelector</name>
  <files>tests/unit/test_model_selector.py</files>
  <action>
Create unit tests for ModelSelector using mocks for ProviderManager:

1. Test tier resolution priority:
   - Role default when no overrides
   - Phase override takes precedence over role default
   - Escalation state takes highest precedence

2. Test provider fallback:
   - Uses first available provider for tier
   - Falls back to next provider when first unavailable
   - Raises NoAvailableKeyError when all providers exhausted

3. Test edge cases:
   - Unknown role falls back to "general" tier
   - Unknown tier in config raises KeyError
   - Empty escalation_state doesn't affect resolution

Use pytest fixtures with mock ProviderManager.
Use unittest.mock.Mock for provider_manager.get_model() returns.
  </action>
  <verify>pytest tests/unit/test_model_selector.py -v</verify>
  <done>All unit tests pass for ModelSelector tier resolution and provider fallback</done>
</task>

</tasks>

<verification>
1. `python -c "from hfs.core.model_selector import ModelSelector"` succeeds
2. `pytest tests/unit/test_model_selector.py -v` passes all tests
3. ModelSelector correctly resolves tiers with proper priority order
</verification>

<success_criteria>
- ModelSelector resolves tiers with correct priority (escalation > phase > role default)
- Provider fallback chain works correctly
- Unit tests cover all tier resolution scenarios
- Code follows existing patterns from providers.py
</success_criteria>

<output>
After completion, create `.planning/phases/05-model-tiers/05-02-SUMMARY.md`
</output>
