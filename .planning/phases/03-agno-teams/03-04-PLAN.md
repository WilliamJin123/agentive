---
phase: 03-agno-teams
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - hfs/agno/teams/consensus.py
  - hfs/presets/consensus.py
  - hfs/agno/teams/__init__.py
  - hfs/tests/test_consensus_agno_triad.py
autonomous: true

must_haves:
  truths:
    - "ConsensusAgnoTriad creates Team with peer_1 + peer_2 + peer_3 (equal authority)"
    - "delegate_to_all_members=True enables parallel dispatch to all peers"
    - "All peers have equal tool access (full HFSToolkit)"
    - "Voting mechanism requires 2/3 majority for decisions"
    - "Session state stores peer proposals for conflict resolution"
  artifacts:
    - path: "hfs/agno/teams/consensus.py"
      provides: "ConsensusAgnoTriad implementation"
      exports: ["ConsensusAgnoTriad"]
    - path: "hfs/tests/test_consensus_agno_triad.py"
      provides: "Unit tests for consensus triad"
      min_lines: 50
  key_links:
    - from: "hfs/agno/teams/consensus.py"
      to: "hfs/agno/teams/base.py"
      via: "AgnoTriad inheritance"
      pattern: "class ConsensusAgnoTriad\\(AgnoTriad\\)"
    - from: "hfs/agno/teams/consensus.py"
      to: "agno.team.Team"
      via: "Team creation with parallel dispatch"
      pattern: "delegate_to_all_members=True"
---

<objective>
Implement ConsensusAgnoTriad - the three equal peers with voting pattern as an Agno Team.

Purpose: Replace stub implementations with real Agno Team coordination where all peers propose simultaneously via parallel dispatch, then vote/negotiate to reach 2/3 majority consensus.

Output: Working ConsensusAgnoTriad with parallel worker dispatch and democratic voting.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-agno-teams/03-CONTEXT.md
@.planning/phases/03-agno-teams/03-RESEARCH.md
@.planning/phases/03-agno-teams/03-01-SUMMARY.md
@hfs/agno/teams/base.py
@hfs/agno/teams/schemas.py
@hfs/presets/consensus.py
@hfs/agno/tools/toolkit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ConsensusAgnoTriad class</name>
  <files>hfs/agno/teams/consensus.py</files>
  <action>
Create ConsensusAgnoTriad extending AgnoTriad base class:

**Imports:**
```python
from agno.team import Team
from agno.agent import Agent
from typing import Dict, Any, List
from hfs.core.triad import TriadConfig, TriadOutput, NegotiationResponse
from hfs.agno.tools import HFSToolkit
from .base import AgnoTriad
from .schemas import PhaseSummary
```

**Class structure:**
1. `_create_agents(self) -> Dict[str, Agent]`:
   Create three equal peer agents with unique perspectives:

   Default perspectives (can be configured):
   - `user_experience` - Focus on end-user experience
   - `technical_correctness` - Focus on technical standards
   - `maintainability` - Focus on long-term maintainability

   All peers have:
   - **Equal tool access**: Full HFSToolkit (per CONTEXT.md - Consensus allows direct peer communication)
   - **Same authority level**: No orchestrator, all peers equal
   - Instructions emphasizing: propose, evaluate, debate, vote, seek consensus

   ```python
   perspectives = ["user_experience", "technical_correctness", "maintainability"]
   for i, perspective in enumerate(perspectives, 1):
       agent = Agent(
           name=f"{self.config.id}_peer_{i}",
           role=f"Equal peer with {perspective} focus",
           model=self.model,
           instructions=self._peer_prompt(perspective),
           tools=[self.toolkit],  # All peers have full access
       )
   ```

2. `_create_team(self) -> Team`:
   Per CONTEXT.md parallel worker dispatch:
   ```python
   return Team(
       name=f"triad_{self.config.id}",
       model=self.model,
       members=list(self.agents.values()),
       delegate_to_all_members=True,  # Parallel broadcast
       share_member_interactions=True,  # Peers see each other
       add_session_state_to_context=True,
       session_state=self._session_state.model_dump(),
       # NOTE: respond_directly must be False with delegate_to_all_members
   )
   ```

3. `_get_phase_summary_prompt(self, phase: str) -> str`:
   For consensus, any peer can produce summary after voting.
   Return prompt that asks for voting results and consensus achieved.

4. Prompt builders for consensus flow:
   - `_build_deliberation_prompt(user_request, spec_state)`:
     All peers propose -> debate -> vote flow
   - `_build_negotiation_prompt(section, other_proposals)`:
     Peers evaluate and vote on response
   - `_build_execution_prompt(frozen_spec)`:
     All peers generate code -> vote on best

5. **Consensus-specific helpers:**
   - `_merge_peer_proposals(result)`: Combine parallel results
   - `_extract_voting_results(result)`: Parse 2/3 majority
   - `_handle_conflict_negotiation(proposals)`: Per CONTEXT.md -
     when parallel workers produce conflicting outputs, trigger negotiation round

**Key patterns from CONTEXT.md:**
- Parallel worker dispatch (delegate_to_all_members=True)
- Process as available (streaming approach)
- Negotiation round for conflicts
- All peers equal authority
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "
from hfs.agno.teams.consensus import ConsensusAgnoTriad
print('ConsensusAgnoTriad imported')
print('Has _create_agents:', hasattr(ConsensusAgnoTriad, '_create_agents'))
print('Has _merge_peer_proposals:', hasattr(ConsensusAgnoTriad, '_merge_peer_proposals'))
"
```
  </verify>
  <done>
ConsensusAgnoTriad class exists with three equal peers, parallel dispatch, and voting mechanism.
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate __init__.py exports and update existing preset</name>
  <files>hfs/agno/teams/__init__.py, hfs/presets/consensus.py</files>
  <action>
1. **Update hfs/agno/teams/__init__.py (CONSOLIDATED - all triads):**
   This task writes the final __init__.py with ALL triad exports.
   03-02 and 03-03 skipped __init__.py to avoid parallel write conflicts.

   ```python
   from .base import AgnoTriad
   from .schemas import PhaseSummary, TriadSessionState, TriadExecutionError
   from .hierarchical import HierarchicalAgnoTriad
   from .dialectic import DialecticAgnoTriad
   from .consensus import ConsensusAgnoTriad

   __all__ = [
       "AgnoTriad",
       "PhaseSummary",
       "TriadSessionState",
       "TriadExecutionError",
       "HierarchicalAgnoTriad",
       "DialecticAgnoTriad",
       "ConsensusAgnoTriad",
   ]
   ```

2. **Update hfs/presets/consensus.py:**
   Add deprecation notice at the top:
   ```python
   """Consensus Triad preset - three equal peers with voting pattern.

   NOTE: For Agno-backed implementation with real LLM calls, use:
   from hfs.agno.teams import ConsensusAgnoTriad

   This module provides the original stub implementation for reference
   and backwards compatibility during migration.
   """
   ```

   Keep existing implementation for Phase 7 cleanup.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "
# All three triads should now be importable from hfs.agno.teams
from hfs.agno.teams import (
    HierarchicalAgnoTriad,
    DialecticAgnoTriad,
    ConsensusAgnoTriad,
)
from hfs.presets.consensus import ConsensusTriad
print('All triad implementations importable')
"
```
  </verify>
  <done>
All three AgnoTriad implementations exported from hfs.agno.teams, existing preset has deprecation notice.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for ConsensusAgnoTriad</name>
  <files>hfs/tests/test_consensus_agno_triad.py</files>
  <action>
Create comprehensive unit tests (no API calls - mock the model):

**Test fixtures:**
- Mock Model that returns canned responses
- Mock Spec with sections for testing
- TriadConfig with consensus preset

**Tests:**
1. `test_consensus_creates_three_peers`:
   Verify _create_agents returns peer_1, peer_2, peer_3

2. `test_all_peers_have_full_toolkit`:
   Verify each peer has complete HFSToolkit access

3. `test_peers_have_unique_perspectives`:
   Verify each peer has different perspective (user_experience, etc.)

4. `test_team_uses_parallel_dispatch`:
   Verify delegate_to_all_members=True

5. `test_team_shares_interactions`:
   Verify share_member_interactions=True

6. `test_session_state_for_peer_proposals`:
   Verify session state can store proposals from all peers

7. `test_deliberation_prompt_mentions_voting`:
   Verify prompt includes voting/consensus instructions

8. `test_no_respond_directly_with_broadcast`:
   Verify respond_directly is NOT True (conflicts with delegate_to_all_members)

9. `test_voting_requires_two_thirds`:
   Verify voting logic requires 2/3 majority (2 of 3 peers)

Use pytest, unittest.mock for Model mocking. No actual API calls.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -m pytest hfs/tests/test_consensus_agno_triad.py -v
```
  </verify>
  <done>
All unit tests pass, verifying parallel dispatch, equal authority, and voting mechanism.
  </done>
</task>

</tasks>

<verification>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive

# 1. Import all triad types from package
python -c "
from hfs.agno.teams import (
    AgnoTriad,
    HierarchicalAgnoTriad,
    DialecticAgnoTriad,
    ConsensusAgnoTriad,
    PhaseSummary,
    TriadSessionState,
)
print('All triad types available')
print('Hierarchical:', issubclass(HierarchicalAgnoTriad, AgnoTriad))
print('Dialectic:', issubclass(DialecticAgnoTriad, AgnoTriad))
print('Consensus:', issubclass(ConsensusAgnoTriad, AgnoTriad))
"

# 2. Run all unit tests
python -m pytest hfs/tests/test_consensus_agno_triad.py -v

# 3. Verify parallel dispatch configuration
python -c "
from unittest.mock import Mock
from hfs.agno.teams import ConsensusAgnoTriad
from hfs.core.triad import TriadConfig, TriadPreset

config = TriadConfig(
    id='test',
    preset=TriadPreset.CONSENSUS,
    scope_primary=['accessibility'],
    scope_reach=['standards'],
    budget_tokens=1000,
    budget_tool_calls=10,
    budget_time_ms=30000,
    objectives=['compliance']
)
mock_model = Mock()
mock_spec = Mock()
mock_spec.sections = {}

try:
    triad = ConsensusAgnoTriad(config, mock_model, mock_spec)
    print('Peers:', list(triad.agents.keys()))
except Exception as e:
    print('Expected with mock:', type(e).__name__)
"
```
</verification>

<success_criteria>
- ConsensusAgnoTriad extends AgnoTriad base class
- Creates three equal peers with unique perspectives
- All peers have full HFSToolkit access
- Team uses delegate_to_all_members=True for parallel dispatch
- Voting logic requires 2/3 majority
- All unit tests pass
- Exportable from hfs.agno.teams
</success_criteria>

<output>
After completion, create `.planning/phases/03-agno-teams/03-04-SUMMARY.md`
</output>
