---
phase: 03-agno-teams
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - hfs/agno/teams/hierarchical.py
  - hfs/presets/hierarchical.py
  - hfs/tests/test_hierarchical_agno_triad.py
autonomous: true

must_haves:
  truths:
    - "HierarchicalAgnoTriad creates Team with orchestrator + worker_a + worker_b"
    - "Orchestrator explicitly delegates tasks via delegate_task_to_member (not broadcast)"
    - "Workers have limited tools (generate_code only), orchestrator has full toolkit"
    - "team.arun() executes deliberate/negotiate/execute phases asynchronously"
    - "Session state preserves context across phases with orchestrator-produced summaries"
  artifacts:
    - path: "hfs/agno/teams/hierarchical.py"
      provides: "HierarchicalAgnoTriad implementation"
      exports: ["HierarchicalAgnoTriad"]
    - path: "hfs/tests/test_hierarchical_agno_triad.py"
      provides: "Unit tests for hierarchical triad"
      min_lines: 50
  key_links:
    - from: "hfs/agno/teams/hierarchical.py"
      to: "hfs/agno/teams/base.py"
      via: "AgnoTriad inheritance"
      pattern: "class HierarchicalAgnoTriad\\(AgnoTriad\\)"
    - from: "hfs/agno/teams/hierarchical.py"
      to: "agno.team.Team"
      via: "Team creation in _create_team"
      pattern: "Team\\("
    - from: "hfs/agno/teams/hierarchical.py"
      to: "agno.agent.Agent"
      via: "Agent creation for orchestrator/workers"
      pattern: "Agent\\("
---

<objective>
Implement HierarchicalAgnoTriad - the orchestrator + 2 workers pattern as an Agno Team.

Purpose: Replace stub implementations with real Agno Team coordination where orchestrator decomposes tasks, delegates to workers, and integrates results - all using team.arun() for async execution.

Output: Working HierarchicalAgnoTriad that extends AgnoTriad base, with orchestrator-directed delegation.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-agno-teams/03-CONTEXT.md
@.planning/phases/03-agno-teams/03-RESEARCH.md
@.planning/phases/03-agno-teams/03-01-SUMMARY.md
@hfs/agno/teams/base.py
@hfs/agno/teams/schemas.py
@hfs/presets/hierarchical.py
@hfs/agno/tools/toolkit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HierarchicalAgnoTriad class</name>
  <files>hfs/agno/teams/hierarchical.py</files>
  <action>
Create HierarchicalAgnoTriad extending AgnoTriad base class:

**Imports:**
```python
from agno.team import Team
from agno.agent import Agent
from typing import Dict, Any
from hfs.core.triad import TriadConfig, TriadOutput, NegotiationResponse
from hfs.agno.tools import HFSToolkit
from .base import AgnoTriad
from .schemas import PhaseSummary
```

**Class structure:**
1. `_create_agents(self) -> Dict[str, Agent]`:
   Create three agents with role-specific tools per CONTEXT.md:

   - **orchestrator**: Full HFSToolkit access
     - Role: "Task coordinator and integrator"
     - Instructions: Include scope, objectives from config
     - Responsibilities: decompose tasks, delegate, integrate, validate

   - **worker_a** and **worker_b**: Limited tools (generate_code only)
     - Role: "Subtask executor"
     - Instructions: Focus on assigned work, clear outputs
     - Tools: Only `self.toolkit.generate_code` method

   Use prompts similar to existing hierarchical.py but adapted for Agno Agent format.

2. `_create_team(self) -> Team`:
   Per CONTEXT.md orchestrator-directed turns:
   ```python
   return Team(
       name=f"triad_{self.config.id}",
       model=self.model,  # Leader model for coordination
       members=list(self.agents.values()),
       delegate_to_all_members=False,  # Orchestrator directs explicitly
       share_member_interactions=True,  # Orchestrator sees worker results
       add_session_state_to_context=True,  # Pass state to prompts
       session_state=self._session_state.model_dump(),
   )
   ```

3. `_get_phase_summary_prompt(self, phase: str) -> str`:
   Return prompt for orchestrator to produce structured summary.

4. Override prompt builders for hierarchical-specific behavior:
   - `_build_deliberation_prompt(user_request, spec_state)`:
     Orchestrator decomposes -> delegates -> integrates
   - `_build_negotiation_prompt(section, other_proposals)`:
     Orchestrator leads negotiation decision
   - `_build_execution_prompt(frozen_spec)`:
     Orchestrator assigns sections to workers

5. Result parsers:
   - `_parse_deliberation_result(result) -> TriadOutput`
   - `_parse_negotiation_result(result) -> NegotiationResponse`
   - `_parse_execution_result(result) -> Dict[str, str]`

**Key patterns from CONTEXT.md:**
- Orchestrator-directed turns (not broadcast)
- Role-specific tools (workers only generate_code)
- Session state for context, not full history sharing
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "
from hfs.agno.teams.hierarchical import HierarchicalAgnoTriad
print('HierarchicalAgnoTriad imported')
print('Has _create_agents:', hasattr(HierarchicalAgnoTriad, '_create_agents'))
print('Has _create_team:', hasattr(HierarchicalAgnoTriad, '_create_team'))
"
```
  </verify>
  <done>
HierarchicalAgnoTriad class exists with _create_agents, _create_team, and all prompt builders implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update existing preset with deprecation notice</name>
  <files>hfs/presets/hierarchical.py</files>
  <action>
**Update hfs/presets/hierarchical.py:**
Add deprecation notice and pointer to new implementation:

At the top of the file, add comment:
```python
"""Hierarchical Triad preset - orchestrator + 2 workers pattern.

NOTE: For Agno-backed implementation with real LLM calls, use:
from hfs.agno.teams import HierarchicalAgnoTriad

This module provides the original stub implementation for reference
and backwards compatibility during migration.
"""
```

Do NOT delete the existing implementation yet - it serves as reference
and will be removed in Phase 7 cleanup.

NOTE: The __init__.py export will be handled by 03-04 which consolidates
all triad exports after all implementations are complete.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "
from hfs.presets.hierarchical import HierarchicalTriad
print('Preset still importable')
"
# Note: HierarchicalAgnoTriad export will be available after 03-04 completes
```
  </verify>
  <done>
Existing preset has deprecation notice. Export deferred to 03-04 consolidated __init__.py update.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for HierarchicalAgnoTriad</name>
  <files>hfs/tests/test_hierarchical_agno_triad.py</files>
  <action>
Create comprehensive unit tests (no API calls - mock the model):

**Test fixtures:**
- Mock Model that returns canned responses
- Mock Spec with sections for testing
- TriadConfig with hierarchical preset

**Tests:**
1. `test_hierarchical_creates_three_agents`:
   Verify _create_agents returns orchestrator, worker_a, worker_b

2. `test_orchestrator_has_full_toolkit`:
   Verify orchestrator's tools include full HFSToolkit

3. `test_workers_have_limited_tools`:
   Verify workers only have generate_code tool

4. `test_team_configuration`:
   Verify Team created with correct settings:
   - delegate_to_all_members=False
   - share_member_interactions=True
   - add_session_state_to_context=True

5. `test_session_state_initialization`:
   Verify _session_state starts with correct structure

6. `test_deliberation_prompt_includes_context`:
   Verify _build_deliberation_prompt includes user_request, spec_state, scope

7. `test_negotiation_prompt_includes_section`:
   Verify _build_negotiation_prompt includes contested section and proposals

8. `test_execution_prompt_includes_frozen_spec`:
   Verify _build_execution_prompt includes frozen spec sections

Use pytest, unittest.mock for Model mocking. No actual API calls.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -m pytest hfs/tests/test_hierarchical_agno_triad.py -v
```
  </verify>
  <done>
All unit tests pass, verifying agent creation, tool assignment, and team configuration.
  </done>
</task>

</tasks>

<verification>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive

# 1. Import from package
python -c "
from hfs.agno.teams import HierarchicalAgnoTriad, AgnoTriad
print('HierarchicalAgnoTriad extends AgnoTriad:', issubclass(HierarchicalAgnoTriad, AgnoTriad))
"

# 2. Run unit tests
python -m pytest hfs/tests/test_hierarchical_agno_triad.py -v

# 3. Verify agent structure
python -c "
from unittest.mock import Mock
from hfs.agno.teams import HierarchicalAgnoTriad
from hfs.core.triad import TriadConfig, TriadPreset

config = TriadConfig(
    id='test',
    preset=TriadPreset.HIERARCHICAL,
    scope_primary=['header'],
    scope_reach=['footer'],
    budget_tokens=1000,
    budget_tool_calls=10,
    budget_time_ms=30000,
    objectives=['test']
)
mock_model = Mock()
mock_spec = Mock()
mock_spec.sections = {}

# This will fail at team creation without real model, but agents should work
try:
    triad = HierarchicalAgnoTriad(config, mock_model, mock_spec)
    print('Agents created:', list(triad.agents.keys()))
except Exception as e:
    print('Expected init issue with mock:', type(e).__name__)
"
```
</verification>

<success_criteria>
- HierarchicalAgnoTriad extends AgnoTriad base class
- Creates orchestrator with full toolkit, workers with limited tools
- Team configured with orchestrator-directed delegation (not broadcast)
- Session state passed to team for context
- All unit tests pass
- Exportable from hfs.agno.teams
</success_criteria>

<output>
After completion, create `.planning/phases/03-agno-teams/03-02-SUMMARY.md`
</output>
