---
phase: 03-agno-teams
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hfs/agno/teams/__init__.py
  - hfs/agno/teams/base.py
  - hfs/agno/teams/schemas.py
  - hfs/agno/__init__.py
autonomous: true

must_haves:
  truths:
    - "AgnoTriad base class can be instantiated with TriadConfig, Model, and Spec"
    - "PhaseSummary model validates phase transition summaries with decisions/questions/artifacts"
    - "TriadSessionState stores role-scoped context for each HFS phase"
    - "TriadExecutionError captures agent, phase, and error context for failure handling"
  artifacts:
    - path: "hfs/agno/teams/base.py"
      provides: "AgnoTriad abstract base class"
      exports: ["AgnoTriad"]
    - path: "hfs/agno/teams/schemas.py"
      provides: "Session state and summary models"
      exports: ["PhaseSummary", "TriadSessionState", "TriadExecutionError"]
    - path: "hfs/agno/teams/__init__.py"
      provides: "Package exports"
      exports: ["AgnoTriad", "PhaseSummary", "TriadSessionState"]
  key_links:
    - from: "hfs/agno/teams/base.py"
      to: "agno.team.Team"
      via: "Team import and wrapping"
      pattern: "from agno\\.team import Team"
    - from: "hfs/agno/teams/base.py"
      to: "hfs/agno/tools/toolkit.py"
      via: "HFSToolkit usage"
      pattern: "from hfs\\.agno\\.tools import HFSToolkit"
---

<objective>
Create the AgnoTriad base class and supporting schemas that all three triad implementations will extend.

Purpose: Establish shared infrastructure for Agno Team wrapping, session state management, error handling, and phase transition summaries - all per CONTEXT.md decisions.

Output: `hfs/agno/teams/` package with base.py, schemas.py ready for triad implementations.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-agno-teams/03-CONTEXT.md
@.planning/phases/03-agno-teams/03-RESEARCH.md
@.planning/phases/02-agno-tools/02-01-SUMMARY.md
@hfs/core/triad.py
@hfs/agno/tools/toolkit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session state and summary schemas</name>
  <files>hfs/agno/teams/schemas.py</files>
  <action>
Create Pydantic models for session state management and error handling:

1. **PhaseSummary**: Structured summary for phase transitions per CONTEXT.md
   - `phase: str` - Phase name (deliberation, negotiation, execution)
   - `decisions: List[str]` - Key decisions made
   - `open_questions: List[str]` - Unresolved questions for next phase
   - `artifacts: Dict[str, str]` - Outputs created (section -> content preview)
   - `produced_by: str` - Agent role that produced this summary

2. **TriadSessionState**: Session state with role-scoped history per CONTEXT.md
   - `current_phase: Optional[str]` - Current HFS phase
   - `deliberation_summary: Optional[PhaseSummary]` - From deliberation
   - `negotiation_summary: Optional[PhaseSummary]` - From negotiation
   - `execution_summary: Optional[PhaseSummary]` - From execution
   - Add helper method `get_phase_context(phase: str) -> Dict` for passing to next phase

3. **TriadExecutionError** (Exception subclass): Per CONTEXT.md failure handling
   - `triad_id: str` - Which triad failed
   - `phase: str` - Which phase (deliberation/negotiation/execution)
   - `agent: str` - Which agent failed (or "unknown")
   - `error: str` - Error message (not full trace per CONTEXT.md)
   - `partial_state: Optional[Dict]` - State preserved for retry

Use Pydantic BaseModel for schemas, standard Exception subclass for error.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "from hfs.agno.teams.schemas import PhaseSummary, TriadSessionState, TriadExecutionError; print('Schemas imported')"
```
  </verify>
  <done>
All three schema classes importable, PhaseSummary validates required fields, TriadExecutionError raises with context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AgnoTriad base class</name>
  <files>hfs/agno/teams/base.py, hfs/agno/teams/__init__.py</files>
  <action>
Create the abstract base class that wraps Agno Team for HFS triads:

**base.py:**
```python
from abc import ABC, abstractmethod
from agno.team import Team
from agno.agent import Agent
from agno.models.base import Model
from typing import Dict, Any, Optional
from hfs.core.triad import TriadConfig, TriadOutput, NegotiationResponse
from hfs.agno.tools import HFSToolkit
from .schemas import PhaseSummary, TriadSessionState, TriadExecutionError
```

1. **AgnoTriad** class (extends ABC):
   - `__init__(config: TriadConfig, model: Model, spec: "Spec")`:
     - Store config, model, spec
     - Create HFSToolkit with spec and triad_id
     - Call abstract `_create_agents()` to get agent dict
     - Call abstract `_create_team()` to get Team instance
     - Initialize `_session_state: TriadSessionState`

   - **Abstract methods** (subclasses implement):
     - `_create_agents(self) -> Dict[str, Agent]` - Create the 3 agents
     - `_create_team(self) -> Team` - Create the Agno Team
     - `_get_phase_summary_prompt(self, phase: str) -> str` - Summary template

   - **Concrete helper methods**:
     - `async def _run_with_error_handling(self, phase: str, prompt: str) -> Any`:
       Per CONTEXT.md - wrap team.arun() with error handling that:
       - Catches exceptions, saves partial state
       - Raises TriadExecutionError with context
       - Preserves state for retry

     - `def _save_partial_progress(self, phase: str) -> None`:
       Save _session_state to `.planning/{triad_id}_{phase}_state.json`
       (Per CONTEXT.md specific markdown state files)

     - `def _load_partial_progress(self, phase: str) -> bool`:
       Load state if exists, return True if loaded

   - **Required Triad interface methods** (concrete implementations using team):
     - `async def deliberate(...)` - Calls _run_with_error_handling
     - `async def negotiate(...)` - Calls _run_with_error_handling
     - `async def execute(...)` - Calls _run_with_error_handling

     These call abstract `_build_deliberation_prompt()`, `_build_negotiation_prompt()`,
     `_build_execution_prompt()` methods for subclass customization.

**Key patterns from CONTEXT.md:**
- Role-scoped history via session_state (NOT add_history_to_context)
- Abort on failure, preserve partial progress
- Synthesizer/orchestrator produces phase summaries (handled by subclass prompts)

**__init__.py:**
Export AgnoTriad and all schemas.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -c "
from hfs.agno.teams import AgnoTriad, PhaseSummary, TriadSessionState
print('AgnoTriad is abstract:', hasattr(AgnoTriad, '__abstractmethods__'))
print('Abstract methods:', AgnoTriad.__abstractmethods__)
"
```
  </verify>
  <done>
AgnoTriad importable, has abstract methods (_create_agents, _create_team), TriadSessionState and PhaseSummary exported.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update hfs/agno exports and add unit tests</name>
  <files>hfs/agno/__init__.py, hfs/tests/test_agno_teams_base.py</files>
  <action>
1. **Update hfs/agno/__init__.py:**
   Add exports for teams module:
   ```python
   from hfs.agno.teams import AgnoTriad, PhaseSummary, TriadSessionState, TriadExecutionError
   ```
   Keep existing ProviderManager and HFSToolkit exports.

2. **Create test file hfs/tests/test_agno_teams_base.py:**
   Test the base infrastructure:

   - `test_phase_summary_validation`: PhaseSummary requires all fields, validates structure
   - `test_triad_session_state_defaults`: TriadSessionState initializes with None phases
   - `test_triad_session_state_get_phase_context`: Returns correct context for each phase
   - `test_triad_execution_error_attributes`: Error captures all required context
   - `test_triad_execution_error_message_format`: Error message includes triad, phase, agent

   - `test_agno_triad_is_abstract`: Cannot instantiate AgnoTriad directly
   - `test_agno_triad_abstract_methods`: Correct abstract methods defined

   Use pytest, no external API calls needed - all unit tests.
  </action>
  <verify>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive
python -m pytest hfs/tests/test_agno_teams_base.py -v
```
  </verify>
  <done>
All tests pass, exports work from both hfs.agno and hfs.agno.teams.
  </done>
</task>

</tasks>

<verification>
```bash
cd C:\Users\jinwi\programming_files_NEW\agentive

# 1. Import all exports from package
python -c "
from hfs.agno import AgnoTriad, PhaseSummary, TriadSessionState, TriadExecutionError, ProviderManager, HFSToolkit
print('All exports available')
"

# 2. Run all unit tests
python -m pytest hfs/tests/test_agno_teams_base.py -v

# 3. Verify abstract class behavior
python -c "
from hfs.agno.teams import AgnoTriad
try:
    AgnoTriad(None, None, None)
except TypeError as e:
    print('Correctly abstract:', 'abstract' in str(e).lower() or 'instantiate' in str(e).lower())
"
```
</verification>

<success_criteria>
- hfs/agno/teams/ package exists with base.py and schemas.py
- AgnoTriad is abstract and cannot be instantiated
- PhaseSummary, TriadSessionState validate correctly
- TriadExecutionError captures triad_id, phase, agent, error
- All unit tests pass
- Exports available from hfs.agno
</success_criteria>

<output>
After completion, create `.planning/phases/03-agno-teams/03-01-SUMMARY.md`
</output>
