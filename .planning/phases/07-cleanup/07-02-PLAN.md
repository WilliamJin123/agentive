---
phase: 07-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hfs/cli/main.py
  - hfs/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "hfs run fails gracefully with clear error when no API keys configured"
    - "Commands like list-presets and validate-config work without API keys"
    - "pytest skips integration tests by default"
    - "pytest --run-integration runs all tests including integration"
  artifacts:
    - path: "hfs/cli/main.py"
      provides: "CLI with pre-flight API key check"
      contains: "check_providers_or_exit"
    - path: "hfs/tests/conftest.py"
      provides: "Pytest configuration with integration marker"
      contains: "pytest_collection_modifyitems"
      contains: "--run-integration"
  key_links:
    - from: "hfs/cli/main.py"
      to: "hfs.agno.get_provider_manager"
      via: "API key validation"
      pattern: "get_provider_manager|list_available_providers"
    - from: "hfs/tests/conftest.py"
      to: "pytest markers"
      via: "pytest_addoption hook"
      pattern: "pytest.mark.integration"
---

<objective>
Add CLI pre-flight API key check and pytest integration marker support

Purpose: Ensure `hfs run` fails gracefully with clear, actionable error messages when API keys are missing. Create conftest.py to skip integration tests by default (need --run-integration flag).

Output:
- hfs/cli/main.py with check_providers_or_exit() function and updated cmd_run()
- hfs/tests/conftest.py with pytest marker configuration
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup/07-RESEARCH.md

# Source files
@hfs/cli/main.py
@hfs/agno/providers.py
@hfs/agno/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI pre-flight API key check</name>
  <files>hfs/cli/main.py</files>
  <action>
Add a pre-flight API key check function to hfs/cli/main.py and update cmd_run() to use it.

1. Add import at top of file (after existing imports):
```python
from hfs.agno import get_provider_manager, list_available_providers
```

2. Add check_providers_or_exit() function before cmd_run():
```python
def check_providers_or_exit() -> Any:
    """Check API key configuration and exit with helpful message if missing.

    Returns:
        ProviderManager instance if providers available

    Exits:
        With code 1 if no providers are configured
    """
    try:
        manager = get_provider_manager()
        available = manager.available_providers
        status = manager.environment_status

        if not available:
            print("Error: No API keys configured.", file=sys.stderr)
            print()
            print("HFS requires at least one LLM provider to be configured.")
            print("Set up API keys using environment variables:")
            print()
            for provider, info in status.items():
                configured = "OK" if info["configured"] else "MISSING"
                print(f"  {provider.upper()}: {configured}")
                if not info["configured"]:
                    print(f"    Set NUM_{provider.upper()} and {provider.upper()}_API_KEY_1..N")
            print()
            print("Example for Cerebras:")
            print("  export NUM_CEREBRAS=1")
            print("  export CEREBRAS_API_KEY_1=your-api-key")
            print()
            print("Run 'hfs list-presets' or 'hfs validate-config' to test CLI without API keys.")
            sys.exit(1)

        # Log available providers
        logger.info(f"Available providers: {', '.join(available)}")
        return manager

    except Exception as e:
        print(f"Error: Failed to initialize providers: {e}", file=sys.stderr)
        logger.exception("Provider initialization failed")
        sys.exit(1)
```

3. Update cmd_run() to use check_providers_or_exit():

After the dry-run check block and before creating the orchestrator, add:
```python
    # Check for API keys (only for non-dry-run)
    manager = check_providers_or_exit()
```

Update the orchestrator creation to use the provider manager. The orchestrator still needs an llm_client parameter, but we'll pass None since the AgnoTriad-based triads get their models directly from ProviderManager:
```python
        orchestrator = HFSOrchestrator(
            config_path=config_path,
            llm_client=None  # AgnoTriad uses ProviderManager directly
        )
```

Remove the print statement about mock client (if not already removed in Plan 01):
- Delete: `print("\nNote: Using mock LLM client. For production, configure actual API credentials.")`
- Delete: `llm_client = MockLLMClient()`

IMPORTANT: Only cmd_run needs the API key check. Other commands (validate-config, list-presets) should continue to work without API keys.
  </action>
  <verify>
Test that validate-config works without API keys:
```bash
# Clear env and test (uses Python subprocess to avoid affecting current env)
python -c "
import subprocess
import os
env = {k: v for k, v in os.environ.items() if 'CEREBRAS' not in k and 'GROQ' not in k and 'GEMINI' not in k and 'OPENROUTER' not in k and 'NUM_' not in k}
result = subprocess.run(['python', '-m', 'hfs.cli.main', 'list-presets'], capture_output=True, text=True, env=env)
print('Exit code:', result.returncode)
print('Output:', result.stdout[:200] if result.stdout else 'None')
"
```
Should work (exit code 0) because list-presets doesn't need API keys.

Test that cmd_run helper function exists:
`python -c "from hfs.cli.main import check_providers_or_exit; print('OK')"`
  </verify>
  <done>check_providers_or_exit() function added to CLI, cmd_run() checks for API keys before pipeline execution, other commands work without API keys</done>
</task>

<task type="auto">
  <name>Task 2: Create pytest conftest.py with integration marker</name>
  <files>hfs/tests/conftest.py</files>
  <action>
Create hfs/tests/conftest.py with pytest configuration for integration test markers.

Create the file with this content:
```python
"""Pytest configuration for HFS tests.

This file configures:
- Integration test markers (skip by default)
- Smoke test markers for quick health checks
- Common fixtures for test isolation

Run integration tests with: pytest --run-integration
Run unit tests only with: pytest (default)
"""

import pytest


def pytest_addoption(parser):
    """Add custom command line options."""
    parser.addoption(
        "--run-integration",
        action="store_true",
        default=False,
        help="Run integration tests that require API keys",
    )


def pytest_configure(config):
    """Register custom markers."""
    config.addinivalue_line(
        "markers",
        "integration: mark test as requiring real API keys (deselected by default)",
    )
    config.addinivalue_line(
        "markers",
        "smoke: mark test as smoke test (quick health check with real APIs)",
    )


def pytest_collection_modifyitems(config, items):
    """Skip integration tests unless explicitly requested."""
    if config.getoption("--run-integration"):
        # --run-integration given, don't skip
        return

    skip_integration = pytest.mark.skip(
        reason="Need --run-integration option to run"
    )
    for item in items:
        if "integration" in item.keywords:
            item.add_marker(skip_integration)
```

This allows:
- `pytest hfs/tests/` - runs only unit tests (integration tests skipped)
- `pytest hfs/tests/ --run-integration` - runs all tests including integration
- `pytest hfs/tests/ -m integration --run-integration` - runs only integration tests
  </action>
  <verify>
Test that conftest.py is loaded and markers work:
```bash
pytest hfs/tests/test_agno_providers.py --collect-only 2>&1 | grep -E "(integration|skip)" | head -5
```
Should show tests being skipped or marked.

Test that --run-integration is recognized:
```bash
pytest --help | grep "run-integration"
```
Should show the option.
  </verify>
  <done>conftest.py created with --run-integration option, integration marker registered, tests skip by default</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. CLI fails gracefully without API keys for `run` command:
   Test with cleared environment to see error message.

2. Other CLI commands work without API keys:
   `python -m hfs.cli.main list-presets` should work
   `python -m hfs.cli.main validate-config --help` should work

3. Pytest integration marker works:
   `pytest hfs/tests/test_agno_providers.py --collect-only`
   Should show integration tests as skipped.

4. No import errors:
   `python -c "from hfs.cli.main import check_providers_or_exit; print('OK')"`
</verification>

<success_criteria>
- [ ] check_providers_or_exit() function added to hfs/cli/main.py
- [ ] cmd_run() calls check_providers_or_exit() before running pipeline
- [ ] validate-config and list-presets work without API keys
- [ ] hfs/tests/conftest.py created with pytest marker configuration
- [ ] --run-integration option recognized by pytest
- [ ] Integration tests skipped by default (without --run-integration)
- [ ] No import errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup/07-02-SUMMARY.md`
</output>
