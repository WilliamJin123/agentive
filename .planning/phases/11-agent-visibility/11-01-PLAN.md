---
phase: 11-agent-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hfs/tui/widgets/agent_tree.py
  - hfs/tui/widgets/negotiation_panel.py
  - hfs/tui/widgets/temperature_bar.py
  - hfs/tui/widgets/__init__.py
autonomous: true

must_haves:
  truths:
    - "User sees agent tree with triad structure showing orchestrator > triad > agent hierarchy"
    - "Each agent node displays role, status icon, and triad-colored styling"
    - "Active/streaming agent has pulsing animation effect"
    - "Negotiation panel shows document-style section list with ownership badges"
    - "Contested sections show claimant names and claim percentages"
    - "Temperature indicator displays color gradient from hot (red) to cool (blue)"
  artifacts:
    - path: "hfs/tui/widgets/agent_tree.py"
      provides: "AgentTreeWidget - Tree subclass with custom node rendering"
      exports: ["AgentTreeWidget"]
    - path: "hfs/tui/widgets/negotiation_panel.py"
      provides: "NegotiationPanel and NegotiationSection widgets"
      exports: ["NegotiationPanel", "NegotiationSection"]
    - path: "hfs/tui/widgets/temperature_bar.py"
      provides: "TemperatureBar widget with color gradient"
      exports: ["TemperatureBar"]
  key_links:
    - from: "hfs/tui/widgets/agent_tree.py"
      to: "hfs/state/models.py"
      via: "imports AgentNode, AgentStatus, TriadInfo"
      pattern: "from hfs\\.state\\.models import"
    - from: "hfs/tui/widgets/negotiation_panel.py"
      to: "hfs/state/models.py"
      via: "imports SectionNegotiationState, NegotiationSnapshot"
      pattern: "from hfs\\.state\\.models import"
    - from: "hfs/tui/widgets/negotiation_panel.py"
      to: "hfs/tui/widgets/temperature_bar.py"
      via: "imports TemperatureBar for section display"
      pattern: "from.*temperature_bar import TemperatureBar"
---

<objective>
Create agent tree and negotiation visualization widgets for HFS inspection mode.

Purpose: Enable users to observe multi-agent triad structure and negotiation state at a glance. The agent tree shows hierarchy with live status, while the negotiation panel presents document ownership with visual temperature indicators.

Output: Three new widgets (AgentTreeWidget, NegotiationPanel, TemperatureBar) ready for use in inspection mode.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-agent-visibility/11-CONTEXT.md
@.planning/phases/11-agent-visibility/11-RESEARCH.md
@hfs/state/models.py
@hfs/tui/theme.py
@hfs/tui/widgets/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentTreeWidget with custom node rendering</name>
  <files>hfs/tui/widgets/agent_tree.py, hfs/tui/widgets/__init__.py</files>
  <action>
Create `hfs/tui/widgets/agent_tree.py` with AgentTreeWidget class:

1. **Subclass Textual's Tree[AgentNode]** for hierarchical agent display

2. **Define triad color mapping** using theme variables:
   - hierarchical: $hfs-hierarchical (#3B82F6 blue)
   - dialectic: $hfs-dialectic (#A855F7 purple)
   - consensus: $hfs-consensus (#22C55E green)

3. **Define status icons** (Unicode icons from RESEARCH.md):
   - IDLE: "" (empty circle)
   - WORKING: "" (play)
   - BLOCKED: "" (pause)
   - COMPLETE: "" (check)

4. **Override render_label()** to customize node display:
   - Status icon with triad color
   - Agent role name in bold triad color
   - Token count in dim text if available (format: `{count:,}`)
   - "..." suffix with blink style if agent.is_streaming

5. **Add populate_from_tree() method** accepting AgentTree model:
   - Clear existing nodes
   - For each triad: add expandable node with f"Triad: {preset}"
   - For each agent in triad: add leaf node with AgentNode data
   - Auto-expand triads that have an active (WORKING) agent

6. **Add reactive `is_live` attribute** (default True) for live update toggle

7. **Add DEFAULT_CSS** for tree styling:
   - Full height, proper padding
   - Guide lines using theme border color

Update `hfs/tui/widgets/__init__.py` to export AgentTreeWidget.

Follow the pattern from RESEARCH.md Pattern 1 (Tree Widget with Custom Node Rendering) and Pattern 6 (Pulsing Animation).
  </action>
  <verify>
Run `python -c "from hfs.tui.widgets import AgentTreeWidget; print('Import OK')"` succeeds.
Run `python -c "from hfs.tui.widgets.agent_tree import AgentTreeWidget; from hfs.state.models import AgentTree, TriadInfo, AgentNode, AgentStatus; tree = AgentTree(triads=[TriadInfo(triad_id='t1', preset='hierarchical', agents=[AgentNode(agent_id='a1', triad_id='t1', role='Architect', status=AgentStatus.WORKING)])]); w = AgentTreeWidget('Agents'); w.populate_from_tree(tree); print('Populate OK')"` succeeds.
  </verify>
  <done>
AgentTreeWidget renders agent hierarchy with triad colors, status icons, and blink effect for streaming agents. Widget exports from hfs.tui.widgets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TemperatureBar and NegotiationPanel widgets</name>
  <files>hfs/tui/widgets/temperature_bar.py, hfs/tui/widgets/negotiation_panel.py, hfs/tui/widgets/__init__.py</files>
  <action>
**Part A: Create `hfs/tui/widgets/temperature_bar.py`:**

1. **TemperatureBar(Static)** widget:
   - Reactive `temperature` attribute (float 0.0-1.0)
   - `watch_temperature()` method to refresh on change
   - `render()` returns Rich Text with color gradient:
     - temp > 0.66: red (#EF4444)
     - temp > 0.33: amber (#F59E0B)
     - temp <= 0.33: blue (#3B82F6)
   - Bar uses filled blocks (█) and empty blocks (░)
   - Append percentage label: f" {temp:.0%}"

2. **DEFAULT_CSS**: height: 1, width: 100%

**Part B: Create `hfs/tui/widgets/negotiation_panel.py`:**

1. **NegotiationSection(Vertical)** widget for single section:
   - Constructor accepts SectionNegotiationState
   - compose() yields:
     - Header Static: section name + owner badge (if owned, green `[{owner}]`)
     - If contested: Collapsible with claims list and TemperatureBar
   - Apply CSS classes: `-contested`, `-claimed` based on status
   - Add DEFAULT_CSS for section borders, padding

2. **NegotiationPanel(VerticalScroll)** container:
   - Constructor takes optional NegotiationSnapshot
   - `set_snapshot(snapshot)` method to update display:
     - Clear children
     - Add header Static showing round and overall temperature
     - Mount NegotiationSection for each section in snapshot
   - `watch_is_paused` reactive for pause/resume updates
   - DEFAULT_CSS: full height, scrollbar, padding

3. **Document-style presentation** (from CONTEXT.md):
   - Sections listed like a document outline with ownership annotations
   - Contested sections expand to show claimants with percentage strength
   - Temperature bar shows per-section heat

Update `hfs/tui/widgets/__init__.py` to export TemperatureBar, NegotiationSection, NegotiationPanel.

Follow RESEARCH.md Pattern 4 (Temperature Gradient Bar) and Code Example (Document-Style Negotiation Section).
  </action>
  <verify>
Run `python -c "from hfs.tui.widgets import TemperatureBar, NegotiationPanel, NegotiationSection; print('Imports OK')"` succeeds.
Run `python -c "from hfs.tui.widgets.temperature_bar import TemperatureBar; t = TemperatureBar(); t.temperature = 0.7; print(f'Temp={t.temperature}, render OK')"` succeeds.
Run `python -c "from hfs.tui.widgets.negotiation_panel import NegotiationPanel; from hfs.state.models import NegotiationSnapshot, SectionNegotiationState; snap = NegotiationSnapshot(temperature=0.8, round=2, sections=[SectionNegotiationState(section_name='Header', status='claimed', owner='Agent1')]); panel = NegotiationPanel(snap); print('Panel OK')"` succeeds.
  </verify>
  <done>
TemperatureBar displays color gradient based on temperature value. NegotiationPanel shows document-style sections with ownership badges, expandable claims for contested sections, and per-section temperature indicators. All widgets export from hfs.tui.widgets.
  </done>
</task>

</tasks>

<verification>
1. All three widget files exist: agent_tree.py, temperature_bar.py, negotiation_panel.py
2. All widgets import successfully from hfs.tui.widgets
3. AgentTreeWidget.populate_from_tree() accepts AgentTree model
4. NegotiationPanel.set_snapshot() accepts NegotiationSnapshot model
5. TemperatureBar.temperature reactive attribute triggers re-render
6. No runtime import errors when loading widget modules
</verification>

<success_criteria>
- AgentTreeWidget renders hierarchical agent tree with triad colors and status icons
- NegotiationPanel shows document-style section list with ownership and claims
- TemperatureBar displays temperature as color-coded bar (red -> amber -> blue)
- All widgets integrate with existing state layer models (AgentTree, NegotiationSnapshot)
- Ready for use in InspectionScreen (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/11-agent-visibility/11-01-SUMMARY.md`
</output>
