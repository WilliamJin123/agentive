---
phase: 11-agent-visibility
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - hfs/tui/widgets/token_breakdown.py
  - hfs/tui/widgets/trace_timeline.py
  - hfs/tui/screens/inspection.py
  - hfs/tui/screens/__init__.py
  - hfs/tui/screens/chat.py
  - hfs/tui/app.py
  - hfs/tui/styles/theme.tcss
  - hfs/tui/widgets/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can type /inspect command to open inspection mode"
    - "Inspection mode shows split view with sidebar navigation"
    - "User can switch between Tree, Negotiation, Tokens, and Trace views via sidebar buttons or number keys (1-4)"
    - "Token breakdown shows usage by agent and by phase with toggle"
    - "Trace timeline shows Gantt-style phase duration bars"
    - "User can press Escape to exit inspection mode and return to chat"
    - "Fullscreen toggle (F key) expands current view"
  artifacts:
    - path: "hfs/tui/widgets/token_breakdown.py"
      provides: "TokenBreakdown DataTable with agent/phase toggle"
      exports: ["TokenBreakdown"]
    - path: "hfs/tui/widgets/trace_timeline.py"
      provides: "TraceTimelineWidget with Gantt-style phase bars"
      exports: ["TraceTimelineWidget"]
    - path: "hfs/tui/screens/inspection.py"
      provides: "InspectionScreen with split view and ContentSwitcher navigation"
      exports: ["InspectionScreen"]
  key_links:
    - from: "hfs/tui/screens/inspection.py"
      to: "hfs/tui/widgets/agent_tree.py"
      via: "imports AgentTreeWidget for tree view"
      pattern: "from.*agent_tree import AgentTreeWidget"
    - from: "hfs/tui/screens/inspection.py"
      to: "hfs/tui/widgets/negotiation_panel.py"
      via: "imports NegotiationPanel for negotiation view"
      pattern: "from.*negotiation_panel import NegotiationPanel"
    - from: "hfs/tui/screens/chat.py"
      to: "hfs/tui/screens/inspection.py"
      via: "/inspect command pushes InspectionScreen"
      pattern: "self\\.app\\.push_screen.*inspection"
    - from: "hfs/tui/widgets/token_breakdown.py"
      to: "hfs/state/models.py"
      via: "imports TokenUsageSummary"
      pattern: "from hfs\\.state\\.models import"
    - from: "hfs/tui/widgets/trace_timeline.py"
      to: "hfs/state/models.py"
      via: "imports TraceTimeline, PhaseTimeline"
      pattern: "from hfs\\.state\\.models import"
---

<objective>
Create inspection mode with split-view navigation for deep state inspection.

Purpose: Enable users to drill down into agent tree, negotiation state, token usage, and trace timeline from a unified inspection interface. The split view preserves chat context while allowing detailed state exploration.

Output: Complete inspection system with TokenBreakdown widget, TraceTimeline widget, InspectionScreen, and /inspect command integration.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-agent-visibility/11-CONTEXT.md
@.planning/phases/11-agent-visibility/11-RESEARCH.md
@.planning/phases/11-agent-visibility/11-01-SUMMARY.md
@hfs/state/models.py
@hfs/state/query.py
@hfs/tui/app.py
@hfs/tui/screens/chat.py
@hfs/tui/styles/theme.tcss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TokenBreakdown and TraceTimelineWidget</name>
  <files>hfs/tui/widgets/token_breakdown.py, hfs/tui/widgets/trace_timeline.py, hfs/tui/widgets/__init__.py</files>
  <action>
**Part A: Create `hfs/tui/widgets/token_breakdown.py`:**

1. **TokenBreakdown(DataTable)** widget:
   - Columns: Name, Prompt, Completion, Total
   - `_view_mode` attribute: "phase" or "agent" (default: "phase")
   - `set_usage(usage: TokenUsageSummary)` method:
     - Clear table
     - If view_mode == "phase": add row per PhaseTokenUsage
     - If view_mode == "agent": add row per AgentTokenUsage
     - Add bold TOTAL row at bottom with `f"{usage.total_tokens:,}"`
   - `cursor_type = "row"` for row selection
   - Bindings:
     - `p` -> `action_show_by_phase()` - switch to phase view
     - `a` -> `action_show_by_agent()` - switch to agent view
   - On mode change, re-call set_usage if data exists

2. **DEFAULT_CSS**: height: 100%

**Part B: Create `hfs/tui/widgets/trace_timeline.py`:**

1. **TraceTimelineWidget(Vertical)** widget:
   - Constructor accepts optional TraceTimeline
   - `BLOCK_CHARS = "...█"` for bar rendering
   - `set_timeline(timeline: TraceTimeline)` method:
     - Clear children
     - Calculate total_ms from timeline.total_duration_ms or sum of phases
     - Mount header Static: "Phase Summary"
     - For each phase: mount `_render_phase_row(phase, total_ms, bar_width=60)`
   - `_render_phase_row()`:
     - Calculate bar_len proportional to phase.duration_ms / total_ms
     - Build Rich Text: `f"{phase.phase_name:20}"` + spaces + `"█" * bar_len` (primary color) + `f" {duration_ms:.0f}ms"` (dim)
     - Return Static widget

2. **Gantt-style presentation** (from CONTEXT.md):
   - Horizontal bars showing relative phase durations
   - Phase names left-aligned, bars to the right
   - Duration label at bar end

3. **DEFAULT_CSS**: height: auto, width: 100%

Update `hfs/tui/widgets/__init__.py` to export TokenBreakdown, TraceTimelineWidget.

Follow RESEARCH.md Pattern 5 (Gantt-Style Timeline) and Code Example (Token Breakdown Table).
  </action>
  <verify>
Run `python -c "from hfs.tui.widgets import TokenBreakdown, TraceTimelineWidget; print('Imports OK')"` succeeds.
Run `python -c "from hfs.tui.widgets.token_breakdown import TokenBreakdown; from hfs.state.models import TokenUsageSummary, AgentTokenUsage; usage = TokenUsageSummary(by_agent=[AgentTokenUsage(agent_id='a1', prompt_tokens=100, completion_tokens=50)]); tb = TokenBreakdown(); print('TokenBreakdown OK')"` succeeds.
Run `python -c "from hfs.tui.widgets.trace_timeline import TraceTimelineWidget; from hfs.state.models import TraceTimeline, PhaseTimeline; from datetime import datetime; tl = TraceTimeline(run_id='r1', started_at=datetime.now(), phases=[PhaseTimeline(phase_name='Init', started_at=datetime.now())]); tw = TraceTimelineWidget(tl); print('Timeline OK')"` succeeds.
  </verify>
  <done>
TokenBreakdown displays token usage table with phase/agent toggle (P/A keys). TraceTimelineWidget renders Gantt-style phase duration bars. Both widgets export from hfs.tui.widgets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create InspectionScreen with split view and navigation</name>
  <files>hfs/tui/screens/inspection.py, hfs/tui/screens/__init__.py, hfs/tui/styles/theme.tcss</files>
  <action>
**Part A: Create `hfs/tui/screens/inspection.py`:**

1. **InspectionScreen(Screen)** class:
   - Compose layout (from CONTEXT.md - split view with sidebar):
     ```
     Horizontal:
       Vertical(id="inspection-sidebar"):  # width: 16
         Button("Tree", id="nav-tree", classes="nav-button -active")
         Button("Negotiation", id="nav-negotiation", classes="nav-button")
         Button("Tokens", id="nav-tokens", classes="nav-button")
         Button("Trace", id="nav-trace", classes="nav-button")
       ContentSwitcher(id="inspection-content", initial="tree"):
         AgentTreeWidget(id="tree", label="Agents")
         NegotiationPanel(id="negotiation")
         TokenBreakdown(id="tokens")
         TraceTimelineWidget(id="trace")
     ```

2. **Bindings** (from RESEARCH.md):
   - `1` -> show_view('tree')
   - `2` -> show_view('negotiation')
   - `3` -> show_view('tokens')
   - `4` -> show_view('trace')
   - `f` -> toggle_fullscreen
   - `escape` -> exit_inspection (pop screen)

3. **Event handlers**:
   - `on_button_pressed(event)`: extract view_id from button id, call action_show_view
   - `action_show_view(view_id)`:
     - Set ContentSwitcher.current = view_id
     - Update button active states (remove `-active` from all, add to selected)
     - Set focus to the newly visible view
   - `action_toggle_fullscreen()`: toggle sidebar visibility (display: none/block)
   - `action_exit_inspection()`: self.app.pop_screen()

4. **State loading** (on_mount):
   - Check if app has query_interface attribute
   - If yes: load initial data into widgets
     - tree.populate_from_tree(query.get_agent_tree())
     - negotiation.set_snapshot(query.get_negotiation_state())
     - tokens.set_usage(query.get_token_usage())
     - timeline.set_timeline(query.get_trace_timeline())
   - If no: show placeholder "No state available" messages

5. **DEFAULT_CSS** inline for basic layout (detailed styles in theme.tcss)

**Part B: Update `hfs/tui/screens/__init__.py`:**
Export InspectionScreen alongside ChatScreen.

**Part C: Add inspection styles to `hfs/tui/styles/theme.tcss`:**
```css
/* Inspection Mode */
InspectionScreen {
    layout: horizontal;
}

#inspection-sidebar {
    width: 16;
    background: $surface;
    border-right: solid $hfs-border;
    padding: 1;
}

#inspection-content {
    width: 1fr;
    height: 100%;
}

.nav-button {
    width: 100%;
    margin: 0 0 1 0;
    background: $panel;
}

.nav-button:hover {
    background: $surface;
}

.nav-button.-active {
    background: $primary;
    color: $background;
    text-style: bold;
}

/* Tree styles */
AgentTreeWidget {
    height: 100%;
    padding: 1;
}

/* Token breakdown styles */
TokenBreakdown {
    height: 100%;
}

/* Timeline styles */
TraceTimelineWidget {
    padding: 1;
}

.timeline-header {
    text-style: bold;
    color: $primary;
    margin: 0 0 1 0;
}

.timeline-row {
    height: 1;
}
```

Follow RESEARCH.md Pattern 2 (Split View with ContentSwitcher Navigation) and Pitfall 5 (Focus Management).
  </action>
  <verify>
Run `python -c "from hfs.tui.screens import InspectionScreen; print('Import OK')"` succeeds.
Run `python -c "from hfs.tui.screens.inspection import InspectionScreen; s = InspectionScreen(); print('Screen OK')"` succeeds.
Verify theme.tcss contains InspectionScreen styles.
  </verify>
  <done>
InspectionScreen provides split-view inspection with sidebar navigation. Four views (Tree, Negotiation, Tokens, Trace) are accessible via buttons or number keys. Escape exits to chat. Fullscreen toggle available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire /inspect command and register screen</name>
  <files>hfs/tui/screens/chat.py, hfs/tui/app.py</files>
  <action>
**Part A: Update `hfs/tui/screens/chat.py`:**

1. **Add /inspect to SLASH_COMMANDS**:
   ```python
   SLASH_COMMANDS: ClassVar[dict[str, str]] = {
       "/help": "show_help",
       "/clear": "clear_conversation",
       "/exit": "quit_app",
       "/inspect": "open_inspection",
   }
   ```

2. **Add `open_inspection()` method**:
   ```python
   def open_inspection(self) -> None:
       """Open inspection mode to view agent and negotiation state."""
       self.app.push_screen("inspection")
   ```

3. **Update help text** in `show_help()` to include /inspect:
   ```
   | `/inspect` | Open inspection mode |
   ```

**Part B: Update `hfs/tui/app.py`:**

1. **Add InspectionScreen to SCREENS**:
   ```python
   from .screens import ChatScreen, InspectionScreen

   SCREENS = {
       "chat": ChatScreen,
       "inspection": InspectionScreen,
   }
   ```

2. **Add optional query_interface attribute** for state access:
   ```python
   def __init__(self) -> None:
       super().__init__()
       self._provider_manager: ProviderManager | None = None
       self._query_interface: QueryInterface | None = None

   @property
   def query_interface(self) -> QueryInterface | None:
       """Get QueryInterface for state queries, if available."""
       return self._query_interface

   def set_query_interface(self, qi: QueryInterface) -> None:
       """Set QueryInterface for inspection mode."""
       self._query_interface = qi
   ```

   Note: The QueryInterface will be wired up when HFS runs with actual state (future integration). For now, InspectionScreen handles None gracefully.

Ensure imports are correct and no circular dependencies.
  </action>
  <verify>
Run `python -c "from hfs.tui.app import HFSApp; app = HFSApp(); print('App OK')"` succeeds.
Run `python -c "from hfs.tui.screens.chat import ChatScreen; print('/inspect' in ChatScreen.SLASH_COMMANDS)"` prints True.
Run `hfs --help` or `python -m hfs --help` to verify CLI still works (no import errors).
  </verify>
  <done>
/inspect command registered in ChatScreen. Typing /inspect pushes InspectionScreen. Help text updated. HFSApp has query_interface property for state access. Full inspection navigation works: sidebar buttons, number keys (1-4), Escape to exit.
  </done>
</task>

</tasks>

<verification>
1. TokenBreakdown and TraceTimelineWidget import from hfs.tui.widgets
2. InspectionScreen imports from hfs.tui.screens
3. Typing /inspect in chat opens inspection mode
4. Pressing Escape in inspection returns to chat
5. Number keys 1-4 switch between Tree/Negotiation/Tokens/Trace views
6. Sidebar buttons work for navigation
7. F key toggles fullscreen (hides/shows sidebar)
8. Help text shows /inspect command
9. No import errors when running `hfs` command
</verification>

<success_criteria>
- Complete inspection mode accessible via /inspect command
- Four navigation views: Tree, Negotiation, Tokens, Trace
- Keyboard navigation: 1-4 for views, Escape to exit, F for fullscreen
- TokenBreakdown shows agent/phase toggle with P/A keys
- TraceTimelineWidget shows Gantt-style phase bars
- Split-view layout with sidebar preserves context
- Graceful handling when QueryInterface is not available
</success_criteria>

<output>
After completion, create `.planning/phases/11-agent-visibility/11-02-SUMMARY.md`
</output>
