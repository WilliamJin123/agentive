---
phase: 06-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hfs/observability/__init__.py
  - hfs/observability/tracing.py
  - hfs/observability/metrics.py
  - hfs/observability/config.py
autonomous: true

must_haves:
  truths:
    - "TracerProvider initializes with BatchSpanProcessor"
    - "MeterProvider initializes with LLM-appropriate histogram buckets"
    - "Console and OTLP exporters are configurable"
    - "Shutdown handler flushes pending telemetry"
  artifacts:
    - path: "hfs/observability/__init__.py"
      provides: "Module exports"
      exports: ["setup_tracing", "setup_metrics", "get_tracer", "get_meter"]
    - path: "hfs/observability/tracing.py"
      provides: "TracerProvider setup and span helpers"
      min_lines: 80
    - path: "hfs/observability/metrics.py"
      provides: "MeterProvider setup with LLM latency buckets"
      min_lines: 60
    - path: "hfs/observability/config.py"
      provides: "Observability configuration"
      min_lines: 30
  key_links:
    - from: "hfs/observability/tracing.py"
      to: "opentelemetry.sdk.trace"
      via: "TracerProvider creation"
      pattern: "TracerProvider"
    - from: "hfs/observability/metrics.py"
      to: "opentelemetry.sdk.metrics"
      via: "MeterProvider creation"
      pattern: "MeterProvider"
---

<objective>
Create the OpenTelemetry observability foundation for HFS.

Purpose: Establish tracing and metrics infrastructure that orchestrator and agents will use to report telemetry. This is the core plumbing before any instrumentation can happen.

Output: New `hfs/observability/` module with TracerProvider, MeterProvider, and configuration utilities.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-observability/06-CONTEXT.md
@.planning/phases/06-observability/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OpenTelemetry dependencies</name>
  <files>hfs/observability/__init__.py</files>
  <action>
Install OpenTelemetry packages if not already present:
- opentelemetry-api (1.39.x)
- opentelemetry-sdk (1.39.x)
- opentelemetry-exporter-otlp-proto-http (1.39.x)

Run: `pip install opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp-proto-http`

Create the `hfs/observability/` directory and `__init__.py` with:
- Public exports: setup_tracing, setup_metrics, get_tracer, get_meter, shutdown_telemetry
- Module docstring explaining the observability layer
  </action>
  <verify>
`pip list | grep opentelemetry` shows api, sdk, and exporter packages installed.
`python -c "from hfs.observability import setup_tracing, setup_metrics, get_tracer, get_meter"` succeeds.
  </verify>
  <done>OpenTelemetry packages installed and module skeleton created with correct exports.</done>
</task>

<task type="auto">
  <name>Task 2: Create tracing.py with TracerProvider setup</name>
  <files>hfs/observability/tracing.py</files>
  <action>
Create `hfs/observability/tracing.py` implementing:

1. `setup_tracing(service_name: str = "hfs") -> TracerProvider`:
   - Create Resource with SERVICE_NAME and service.version
   - Create TracerProvider with resource
   - Add BatchSpanProcessor with ConsoleSpanExporter (always, for dev visibility)
   - Add BatchSpanProcessor with OTLPSpanExporter if OTEL_EXPORTER_OTLP_ENDPOINT env var set
   - Set as global tracer provider via trace.set_tracer_provider()
   - Return the provider for shutdown handling

2. `get_tracer(name: str = "hfs.observability", version: str = "0.1.0") -> Tracer`:
   - Return tracer from global provider

3. `truncate_prompt(prompt: str, max_length: int = 200) -> str`:
   - Replace newlines with spaces
   - Truncate to max_length with "..." if needed
   - Per RESEARCH.md recommendation

4. Module-level `_tracer_provider: Optional[TracerProvider]` for shutdown access

Use BatchSpanProcessor for both console and OTLP (per RESEARCH.md - SimpleSpanProcessor blocks).

Reference RESEARCH.md code examples for exact API usage.
  </action>
  <verify>
```python
python -c "
from hfs.observability.tracing import setup_tracing, get_tracer, truncate_prompt
provider = setup_tracing()
tracer = get_tracer()
with tracer.start_as_current_span('test') as span:
    span.set_attribute('test', True)
print('Tracing setup successful')
# Test truncate
assert truncate_prompt('hello\\nworld', 10) == 'hello w...'
"
```
  </verify>
  <done>TracerProvider initializes with BatchSpanProcessor, console exporter works, truncate_prompt helper available.</done>
</task>

<task type="auto">
  <name>Task 3: Create metrics.py and config.py with shutdown handler</name>
  <files>hfs/observability/metrics.py, hfs/observability/config.py, hfs/observability/__init__.py</files>
  <action>
Create `hfs/observability/metrics.py` implementing:

1. `LLM_LATENCY_BUCKETS = (0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 30.0, 60.0)` - per CONTEXT.md

2. `setup_metrics(service_name: str = "hfs") -> MeterProvider`:
   - Create Resource with SERVICE_NAME
   - Create PeriodicExportingMetricReader with ConsoleMetricExporter
   - Add OTLPMetricExporter reader if OTEL_EXPORTER_OTLP_ENDPOINT set
   - Create View for "hfs.*.duration" instruments with ExplicitBucketHistogramAggregation using LLM_LATENCY_BUCKETS
   - Create MeterProvider with resource, readers, and views
   - Set as global meter provider
   - Return provider for shutdown

3. `get_meter(name: str = "hfs.metrics", version: str = "0.1.0") -> Meter`:
   - Return meter from global provider

4. Pre-defined instruments (create in setup_metrics or lazily):
   - `phase_duration`: Histogram for hfs.phase.duration (unit: "s")
   - `triad_duration`: Histogram for hfs.triad.duration (unit: "s")
   - `agent_duration`: Histogram for hfs.agent.duration (unit: "s")
   - `phase_success_count`: Counter for hfs.phase.success.count (unit: "{execution}")
   - `phase_failure_count`: Counter for hfs.phase.failure.count (unit: "{execution}")
   - `tokens_total`: Counter for hfs.tokens.total (unit: "{token}")

Create `hfs/observability/config.py` implementing:

1. `ObservabilityConfig` dataclass or Pydantic model:
   - service_name: str = "hfs"
   - console_enabled: bool = True
   - console_verbosity: Literal["minimal", "standard", "verbose"] = "standard"
   - otlp_endpoint: Optional[str] = None (defaults to env var)

2. `get_config() -> ObservabilityConfig`:
   - Load from environment or defaults

Update `hfs/observability/__init__.py` to add:
- shutdown_telemetry() function that calls force_flush and shutdown on both providers
- Register shutdown_telemetry with atexit for graceful cleanup
  </action>
  <verify>
```python
python -c "
from hfs.observability.metrics import setup_metrics, get_meter, LLM_LATENCY_BUCKETS
from hfs.observability.config import ObservabilityConfig, get_config
from hfs.observability import shutdown_telemetry

# Test metrics
provider = setup_metrics()
meter = get_meter()
histogram = meter.create_histogram('test.duration', unit='s')
histogram.record(1.5, {'phase': 'test'})
print('Metrics setup successful')

# Test config
config = get_config()
assert config.service_name == 'hfs'
print('Config loaded:', config)
print('LLM buckets:', LLM_LATENCY_BUCKETS)

# Verify shutdown_telemetry is callable
assert callable(shutdown_telemetry)
print('shutdown_telemetry available')
"
```
  </verify>
  <done>MeterProvider initializes with LLM-appropriate histogram buckets (0.1s to 60s), config utilities available, shutdown handler registered with atexit.</done>
</task>

</tasks>

<verification>
1. All files exist in hfs/observability/:
   - __init__.py with correct exports
   - tracing.py with setup_tracing, get_tracer, truncate_prompt
   - metrics.py with setup_metrics, get_meter, LLM_LATENCY_BUCKETS
   - config.py with ObservabilityConfig

2. Import test passes:
   ```python
   from hfs.observability import (
       setup_tracing, setup_metrics,
       get_tracer, get_meter,
       shutdown_telemetry
   )
   ```

3. TracerProvider creates spans that appear in console output

4. MeterProvider creates histograms with correct bucket boundaries
</verification>

<success_criteria>
- OpenTelemetry packages installed (api, sdk, exporter)
- hfs/observability module created with 4 files
- TracerProvider initializes with BatchSpanProcessor and console exporter
- MeterProvider initializes with LLM latency buckets (0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 30.0, 60.0)
- OTLP exporter enabled when OTEL_EXPORTER_OTLP_ENDPOINT env var set
- shutdown_telemetry() registered with atexit for graceful cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/06-observability/06-01-SUMMARY.md`
</output>
